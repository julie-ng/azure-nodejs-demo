name: $(BuildID)

trigger:
  branches:
    include:
    # - fix/*
    # - feat/*
    # - main
    - feat/split-pipeline
  tags:
    include:
    - v*
  paths:
    exclude:
    - README.md

pr:
- main

pool:
  vmImage: 'ubuntu-latest'

# schedules:
#   - cron: "0 12 * * 0"
#     displayName: Weekly Sunday build
#     always: true
#     branches:
#       include:
#       - main

variables:
  - name: isMain
    value: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/main') }}

  - name: isTag
    value: ${{ startsWith(variables['Build.SourceBranch'], 'refs/tags/v') }}

  - name: notFork
    value: ${{ eq(variables['System.PullRequest.IsFork'], 'False') }}

  - name: notPR
    value: ${{ ne(variables['Build.Reason'], 'PullRequest') }}

  - name: notSchedule
    value: ${{ ne(variables['Build.Reason'], 'Schedule') }}

  - name: isTrustedCI
    value: ${{ and(variables.notFork, variables.notPR, variables.notSchedule) }}


stages:
- stage: Tests
  # condition: eq(variables.isTag, false) # not(variables.isTag) does not work ü§∑‚Äç‚ôÄÔ∏è
  condition: not(${{ variables.isTag }}) # not(variables.isTag) does not work ü§∑‚Äç‚ôÄÔ∏è
  jobs:
  - job: Tests
    steps:
    - script: |
        echo 'debug test stage'
    # - script: npm ci
    #   displayName: npm install

    # - script: npm audit --audit-level=moderate
    #   displayName: npm audit (Dev)
    #   continueOnError: true

    # - script: npm audit --production --audit-level=high
    #   displayName: npm audit (Prod)

    # - script: npm run lint
    #   displayName: linter

    # - script: npm run test
    #   displayName: tests

    # - script: docker build -t $(image-tag) .
    #   displayName: docker build

    # - task: SnykSecurityScan@0
    #   displayName: Snyk Container Security Scan
    #   inputs:
    #     serviceConnectionEndpoint: 'snyk-api-connection'
    #     testType: 'container'
    #     dockerImageName: $(image-tag)
    #     dockerfilePath: 'Dockerfile'
    #     monitorOnBuild: true
    #     failOnIssues: true



  # condition: or(succeeded('Test'), ${{ variables['should-build'] }})
  # and(succeeded(), eq(variables.isMain, true))
  # condition: or(eq(variables.isTag, true), and(succeeded(), variables.isMain, variables.internalCI))
- stage: Build
  displayName: Build Docker Image
  condition: or(eq(variables.isTag, true), and(succeeded(), ${{ variables.isMain }}, ${{ variables.isTrustedCI }}))
  variables:
  - group: azure-demos-config
  - name: image-tag
    ${{ if eq(variables.isTag, 'True') }}:
      value: ${{ replace(variables['Build.SourceBranch'], 'refs/tags/v', '') }}
    ${{ if eq(variables.isTag, 'False') }}:
      value: dev
  jobs:
  - job: Build
    steps:
    - script: |
        echo '[default] image-tag: $(image-tag)'
        echo '[default] isTag: $(isTag)'
        echo '[default] isMain: $(isMain)'
        echo '[default] isTrustedCI: $(isTrustedCI)'
      displayName: 'Debug: values'
